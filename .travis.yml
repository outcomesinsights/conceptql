---
language: ruby
rvm:
  - 2.4
dist: trusty
sudo: false
gemfile: ".ci.Gemfile"
env:
  global:
    - LEXICON_URL=postgres://postgres@localhost/lexicon CONCEPTQL_DATA_MODEL=gdm SEQUELIZER_URI="postgres://localhost/postgres?username=postgres"
addons:
  postgresql: '9.6'
  apt:
    packages:
      - python-pip
      - pigz

services:
  - postgresql

before_install:
  - sudo mount -o remount,size=60% /var/ramfs
  - pip install --user pyOpenSSL cryptography idna certifi "urllib3[secure]" sqlparse
  - sqlite3 --version
  - psql -c "create database lexicon;" -U postgres
  - curl -sSL "http://chisel.lexicon.jsaw.io" | pigz -dc | psql postgres://postgres@localhost/lexicon > /tmp/restore.log 2>&1 || cat /tmp/restore.log
  - gem update --system && gem install bundler tping

script:
  - travis_wait 45 bash .travis.postgres.sh
  - tping --token $TRAVIS_PRO_TOKEN --user outcomesinsights --repo jigsaw-diagram-editor --pro --branch $TRAVIS_BRANCH
  - tping --token $TRAVIS_PRO_TOKEN --user outcomesinsights --repo t_shank --pro --branch $TRAVIS_BRANCH

notifications:
  slack:
    secure: YrvvLrIOgRIzqb01GbektA0YZXCieghuhaU3O4vBW/otrz26twb/0zeB/HHqKS3P2re0R127wGw6nAUAG9ieEHPYMKcpZZWzvnPrqQ/5ASbIZWX85fps0svFEeQTqRjK8TdHC/0ZJoy3P7i6wgBoWcs434aSR4K6KgisdWJATk0=
