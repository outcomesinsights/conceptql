SELECT * FROM (SELECT * FROM (SELECT `l`.*, `r`.`window_id` FROM (SELECT * FROM (SELECT `person_id` AS `person_id`, `condition_occurrence_id` AS `criterion_id`, CAST('condition_occurrence' AS string) AS `criterion_table`, CAST('condition_occurrence' AS string) AS `criterion_domain`, CAST(`condition_start_date` AS timestamp) AS `start_date`, CAST(coalesce(`condition_end_date`, `condition_start_date`) AS timestamp) AS `end_date`, CAST(`condition_source_value` AS string) AS `source_value`, CAST(`condition_source_vocabulary_id` AS string) AS `source_vocabulary_id` FROM `condition_occurrence` AS `tab` WHERE ((`condition_source_value` IN ('412')) AND (`condition_source_vocabulary_id` = 2))) AS `t1`) AS `l` INNER JOIN (SELECT `person_id`, `start_date`, `end_date`, row_number() OVER (ORDER BY `person_id`, concat(CAST(`start_date` AS string), '_', CAST(`person_id` AS string)), concat(CAST(`end_date` AS string), '_', CAST(`person_id` AS string))) AS `window_id` FROM `jtemp` GROUP BY `person_id`, `start_date`, `end_date`) AS `r` ON ((`l`.`person_id` = `r`.`person_id`) AND (CAST((CAST(`r`.`start_date` AS timestamp) + INTERVAL -30 days) AS timestamp) <= `l`.`start_date`) AND (`l`.`end_date` <= CAST((CAST(`r`.`end_date` AS timestamp) + INTERVAL 1 months) AS timestamp)))) AS `t1`) AS `t1`